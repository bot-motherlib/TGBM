name: CI_ubuntu
permissions:
  actions: write
  contents: read

'on':
  pull_request:
  push:
    branches:
      - master

env:
  UBSAN_OPTIONS: print_stacktrace=1
  LIBRARY_PATH: /usr/lib/gcc/x86_64-linux-gnu/12
  LD_LIBRARY_PATH: /usr/lib/gcc/x86_64-linux-gnu/12

jobs:
  posix:
    strategy:
      fail-fast: false
      matrix:
        include:
          # - type: Debug
          #   compiler: clang
          #   cxx_compiler: clang++
          #   version: 17
          
          - type: debug
            compiler: clang
            version: 19

          # - type: Debug
          #   compiler: gcc
          #   cxx_compiler: g++
          #   version: 11 
          
          - type: debug
            compiler: gcc
            version: 14

    name: '${{matrix.type}} ${{matrix.compiler}}-${{matrix.version}}'
    runs-on: ubuntu-24.04 #bug in std library(https://gcc.gnu.org/bugzilla/show_bug.cgi?id=115119)

    steps:
      - name: Cancel Previous Runs
        uses: styfle/cancel-workflow-action@0.9.1

      - name: Checkout the code
        uses: actions/checkout@v2

      - name: install based dependencies
        run: |
          sudo apt install ccache
          sudo apt install cmake
          cmake --version
          sudo apt install lld
          sudo apt install ninja-build
          sudo apt install build-essential
      - name: install compiler
        run: >
          sudo make 
          -f scripts/ci_ubuntu.make 
          install-compiler 
          compiler=${{matrix.compiler}} 
          version=${{matrix.version}}
      - name: install modern stdlib
        run: |
          ls /usr/lib/gcc/x86_64-linux-gnu
          sudo apt install libx32stdc++-12-dev
      - name: Setup ccache
        run: |
          ccache -M 2.0GB

      - name: Reuse ccache directory
        uses: actions/cache@v2
        with:
          path: ~/.cache/ccache
          key: 'ubuntu-24.04 ${{matrix.type}} ${{matrix.compiler}}-${{matrix.version}} ccache-dir ${{github.ref}}'
          restore-keys: |
            ubuntu-24.04 ${{matrix.type}} ${{matrix.compiler}}-${{matrix.version}} ccache-dir ${{github.ref}}
            ubuntu-24.04 ${{matrix.type}} ${{matrix.compiler}}-${{matrix.version}} ccache-
      
      - name: ccache stats before build
        run: |
          ccache -s

      - name: Configure cmake project
        run: >
          cmake 
            --preset ${{matrix.compiler}}_${{matrix.version}}_${{matrix.type}} 
            --preset_file scripts/presets_ubuntu-24.04.json

      - name: Build project
        run: >
          cmake 
          --build cmake_build
          --target all

      - name: ccache stats after build
        run: |
          ccache -s

      - name: Run tests
        run: | 
          cd cmake_build && ctest -V
